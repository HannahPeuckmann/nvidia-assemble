#!/bin/sh
set -eux

nvidia_dir=/lib/modules/*/kernel/nvidia-*
# Check nvidia_dir
[ -e $nvidia_dir/bits/SHA256SUMS ]

if ! cmp -s $nvidia_dir/bits/SHA256SUMS $SNAP_COMMON/nvidia-driver/bits/SHA256SUMS
then
    rm -rf $SNAP_COMMON/nvidia-driver
    cp -r $nvidia_dir $SNAP_COMMON/nvidia-driver
    cd $SNAP_COMMON/nvidia-driver/bits
    sed -i 's|/usr/bin/ld.bfd|ld.bfd|' BUILD
    sh BUILD
fi

modprobe nvidia-drm modeset=1 || echo connect kernel-module-control
modprobe nvidia-uvm || echo connect kernel-module-control
